<style>
  body {
    overflow-x: hidden;
  }
  body.no-scroll {
    overflow: hidden;
    padding-right: 15px;
  }
  .full-width-page {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    margin-right: calc(-50vw + 50%);
  }

  .comments-sidebar {
    position: fixed;
    top: 0;
    right: -750px;
    width: 750px;
    height: 100vh;
    background-color: #f8f9fa;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1050;
    overflow-y: hidden;
    transition: right 0.5s ease-in-out;
  }

  .comments-sidebar.show {
    right: 0;
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
  }

  .overlay.show {
    display: block;
  }

  .placeholder-text {
    color: #6c757d;
  }

  .comment-textarea {
    display: none;
    margin-top: 15px;
    margin-left: 40px;
  }

  .reply-button {
    cursor: pointer;
  }

  .comment-textarea.show {
    display: block;
  }
</style>

<body>
  <div class="container-fluid px-0 full-width-page">
    <div class="row g-0">
      <!-- Sidebar tr√°i (col-3) -->
      <div class="col-3">
        <div class="bg-white p-5 mt-5 h-100 d-flex flex-column rounded-1">
          <a href="/@son-son-16" class="text-decoration-none text-dark">
            <h6 class="fw-semibold text-start">{{author.fullName}}</h6>
          </a>

          <hr class="w-200 m-0 mb-4 mt-2">

          <div class="d-flex gap-5">
            <button class="btn btn-sm d-flex align-items-center gap-2 p-0 text-secondary bg-transparent" style="border: none; font-size: 17px;" title="Nh·∫•n ƒë·ªÉ th√≠ch b√†i n√†y">
              <i class="fa-regular fa-heart"></i>
              <span>568</span>
            </button>

            <button class="btn btn-sm d-flex align-items-center gap-2 p-0 text-secondary bg-transparent" style="border: none; font-size: 17px;" onclick="toggleComments()" title="B√¨nh lu·∫≠n">
              <i class="fa-regular fa-comment"></i>
              <span>{{post.commentCount}}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- N·ªôi dung ch√≠nh (col-8) -->
      <div class="col-6">
        <div class="container my-5">
          <div class="mb-3">
            <a onclick="history.back()" class="text-muted" style="cursor: pointer;">
              <i class="fa-solid fa-reply fa-sm me-2"></i>Quay l·∫°i
            </a>
          </div>

          <h1 class="fw-bold fs-2 mb-5">{{post.title}}</h1>

          <div class="d-flex align-items-center gap-3 mb-4">
            <img src="{{author.avatar}}" class="rounded-circle" width="50" height="50">
            <div>
              <strong class="d-block">{{author.fullName}}</strong>
              <small class="text-muted">{{timeAgo post.createdAt}}</small>
            </div>
          </div>

          <div class="mb-5">
            {{{post.content}}}
          </div>

          <hr class="my-5">

          <h4 class="mb-4 title-strong">üî•C√°c b√†i vi·∫øt n·ªïi b·∫≠t kh√°c</h4>
          <div class="row">
            {{#each relatedPosts}}
            <div class="col-md-4 mb-4">
              <div class="card h-100 shadow-sm border-0 rounded-4">
                <a href="/posts/{{this.slug}}">
                  <img src="{{this.thumbnail}}" class="card-img-top rounded-top-4" style="height: 180px; object-fit: cover;">
                </a>
                <div class="card-body">
                  <h5 class="card-title">{{this.title}}</h5>
                  <p class="card-text text-muted small">{{this.description}}</p>
                  <a href="/posts/{{this.slug}}" class="btn-grad"> Xem ti·∫øp</a>
                </div>
              </div>
            </div>
            {{/each}}
          </div>
        </div>
      </div>

      <!-- col-2 (sidebar b√¨nh lu·∫≠n) -->
      <div class="col-2">
        <div class="comments-sidebar bg-white" id="commentsSidebar">
          <!-- N√∫t ƒë√≥ng -->
          <div class="d-flex justify-content-end">
            <button class="btn btn-link text-secondary fs-5" onclick="toggleComments(true)" style="text-decoration: none;">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="bg-light p-3 ps-5 pe-5 d-flex flex-column bg-white" style="height: 100%;">
            <!-- Form nh·∫≠p b√¨nh lu·∫≠n -->
            <form action="/comments/{{post._id}}" method="POST">
              <div class="mb-4">
                <div class="d-flex align-items-start gap-2">
                  <img src="{{account.avatar}}" class="rounded-circle" width="40" height="40">
                  <div id="commentInputTrigger" class="form-control placeholder-text" onclick="showCommentInput()" style="cursor: text; background-color:#eef4fc; border: 0px;">
                    Nh·∫≠p b√¨nh lu·∫≠n m·ªõi c·ªßa b·∫°n
                  </div>
                  <textarea id="commentInputArea" name="content" class="form-control d-none" rows="3" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..."></textarea>
                </div>
                <div id="commentActions" class="d-none mt-4 d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-grad-cancel align-self-center" onclick="hideCommentInput()" style="width: 150px; height: 35px;">H·ªßy</button>
                  <button type="submit" class="btn btn-grad btn-sm" style="width: 150px; height: 35px;">B√¨nh lu·∫≠n</button>
                </div>
              </div>
            </form>

            <!-- Danh s√°ch b√¨nh lu·∫≠n -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="mb-0">B√¨nh lu·∫≠n ({{post.commentCount}})</h5>
            </div>

            <div class="flex-grow-1 overflow-auto">
              <div class="mb-4">
                {{#each comments}}
                  <div class="mb-5 comment-item">
                    <div class="d-flex gap-2 mb-3">
                      <img src="{{this.user.avatar}}" class="rounded-circle" width="40" height="40">
                      <div class="d-flex justify-content-between align-items-center">
                        <strong class="d-block" style="color: #ff7e5f;">{{this.user.fullName}}</strong>
                        <small class="text-muted" style="margin-top: 1px;">{{timeAgo this.createdAt}}</small>
                      </div>
                    </div>
                    <p>{{this.content}}</p>
                    <div class="gap-3 d-flex align-items-center">
                      <button class="btn btn-link p-0 fw-semibold text-decoration-none" style="color: #ff7e5f;" >Th√≠ch</button>
                      <button class="btn btn-link p-0 fw-semibold text-decoration-none reply-button" data-id="{{this.user._id}}" data-fullName="{{this.user.fullName}}" style="color: #ff7e5f;" onclick="showReplyInput(this)">Tr·∫£ l·ªùi</button>
                    </div>
                    <!-- Reply Textarea -->
                    <form action="/comments/{{this._id}}/reply" method="POST" class="comment-textarea">
                      <div class="d-flex align-items-start gap-2">
                        <img src="{{@root.account.avatar}}" class="rounded-circle" width="40" height="40">
                        <div class="form-control" contenteditable="true" style="min-height: 60px; border-radius: 10px;" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." oninput="updateHiddenInput(this)">
                            <span class="reply-mention" contenteditable="false"></span>
                            
                        </div>
                        <input type="hidden" name="replies" value="">
                      </div>
                      <div class="mt-4 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-grad-cancel btn-sm align-self-center" onclick="hideReplyInput(this)" style="width: 150px; height: 35px; border-radius: 10px;" >H·ªßy</button>
                        <button type="submit" class="btn btn-grad btn-sm" style="width: 150px; height: 35px;">Tr·∫£ l·ªùi</button>
                      </div>
                    </form>
                    <!-- Replies Section -->
                    <div class="mt-4 ps-5 border-start">
                      {{#each this.replies}}
                        <div class="mb-4 reply-item"> <!-- Th√™m class reply-item -->
                          <div class="d-flex gap-2 mb-3">
                            <img src="{{this.user.avatar}}" class="rounded-circle" width="35" height="35">
                            <div class="d-flex gap-2">
                              <strong class="d-block" style="color: #ff7e5f;">{{this.user.fullName}}</strong>
                              <small class="text-muted" style="margin-top: 1px;">{{timeAgo this.createdAt}}</small>
                            </div>
                          </div>
                          <p class="mt-2"><span class="reply-mention">{{this.replyToUser.fullName}}</span> {{this.content}}</p>
                          <div class="gap-3 d-flex align-items-center">
                            <button class="btn btn-link p-0 fw-semibold text-decoration-none" style="color: #ff7e5f;">Th√≠ch</button>
                            <button class="btn btn-link p-0 fw-semibold text-decoration-none reply-button" style="color: #ff7e5f;" onclick="showReplyInput(this)" data-id="{{this.user._id}}" data-fullName="{{this.user.fullName}}">Tr·∫£ l·ªùi</button>
                          </div>

                          <!-- Reply Textarea (di chuy·ªÉn v√†o trong m·ªói reply-item) -->
                          <form action="/comments/{{../_id}}/reply" method="POST" class="comment-textarea">
                            <div class="d-flex align-items-start gap-2 mt-3">
                              <img src="{{@root.account.avatar}}" class="rounded-circle" width="40" height="40">
                              <div class="form-control" contenteditable="true" style="min-height: 60px; border-radius: 10px;" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." oninput="updateHiddenInput(this)">
                                  <span class="reply-mention" contenteditable="false"></span>
                              </div>
                              <input type="hidden" name="replies" value="">
                            </div>
                            <div class="mt-4 d-flex justify-content-end gap-2">
                              <button type="button" class="btn btn-grad-cancel btn-sm align-self-center" onclick="hideReplyInput(this)" style="width: 150px; height: 35px; border-radius: 10px;">H·ªßy</button>
                              <button type="submit" class="btn btn-grad btn-sm" style="width: 150px; height: 35px;">Tr·∫£ l·ªùi</button>
                            </div>
                          </form>
                        </div>
                      {{/each}}
                    </div>
                  </div>
                {{/each}}
              </div>

              <!-- Th√™m b√¨nh lu·∫≠n kh√°c t·∫°i ƒë√¢y -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Overlay -->
<div class="overlay" onclick="toggleComments(true)"></div>
</body>

<script>

  // H√†m ƒë·ªÉ b·∫≠t/t·∫Øt sidebar b√¨nh lu·∫≠n
  function toggleComments(forceClose = false) {
      const sidebar = document.getElementById('commentsSidebar'); // L·∫•y ph·∫ßn t·ª≠ sidebar b√¨nh lu·∫≠n
      const overlay = document.querySelector('.overlay'); // L·∫•y ph·∫ßn t·ª≠ overlay (l·ªõp ph·ªß)
      const body = document.body; // L·∫•y ph·∫ßn t·ª≠ body c·ªßa trang

      if (forceClose) { // N·∫øu forceClose l√† true, ƒë√≥ng sidebar
          sidebar.classList.remove('show'); // ·∫®n sidebar
          overlay.classList.remove('show'); // ·∫®n overlay

          setTimeout(() => {
              body.classList.remove('no-scroll'); // B·ªè l·ªõp no-scroll ƒë·ªÉ cho ph√©p cu·ªôn trang
              body.style.paddingRight = ''; // X√≥a padding right ƒë·ªÉ tr√°nh nh·∫£y giao di·ªán
          }, 300);

          hideCommentInput(); // ·∫®n input b√¨nh lu·∫≠n n·∫øu ƒëang hi·ªÉn th·ªã
          return;
      }

      // N·∫øu forceClose l√† false, m·ªü sidebar
      sidebar.classList.add('show'); // Hi·ªÉn th·ªã sidebar
      overlay.classList.add('show'); // Hi·ªÉn th·ªã overlay
      body.classList.add('no-scroll'); // Th√™m l·ªõp no-scroll ƒë·ªÉ ngƒÉn cu·ªôn trang

      // Ch·ªëng "nh·∫£y" giao di·ªán do scrollbar m·∫•t
      const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
      if (scrollBarWidth > 0) {
          body.style.paddingRight = scrollBarWidth + 'px'; // Th√™m padding right ƒë·ªÉ b√π tr·ª´ kho·∫£ng tr·ªëng scrollbar
      }
  }

  // H√†m ƒë·ªÉ hi·ªÉn th·ªã input b√¨nh lu·∫≠n
  function showCommentInput() {
      document.getElementById('commentInputTrigger').classList.add('d-none'); // ·∫®n n√∫t k√≠ch ho·∫°t input b√¨nh lu·∫≠n
      document.getElementById('commentInputArea').classList.remove('d-none'); // Hi·ªÉn th·ªã input b√¨nh lu·∫≠n
      document.getElementById('commentActions').classList.remove('d-none'); // Hi·ªÉn th·ªã n√∫t g·ª≠i v√† h·ªßy
      document.getElementById('commentInputArea').focus(); // T·∫≠p trung v√†o input b√¨nh lu·∫≠n
  }

  // H√†m ƒë·ªÉ ·∫©n input b√¨nh lu·∫≠n
  function hideCommentInput() {
      document.getElementById('commentInputTrigger').classList.remove('d-none'); // Hi·ªÉn th·ªã n√∫t k√≠ch ho·∫°t input b√¨nh lu·∫≠n
      document.getElementById('commentInputArea').classList.add('d-none'); // ·∫®n input b√¨nh lu·∫≠n
      document.getElementById('commentActions').classList.add('d-none'); // ·∫®n n√∫t g·ª≠i v√† h·ªßy
  }

  // H√†m ƒë·ªÉ hi·ªÉn th·ªã input tr·∫£ l·ªùi
  function showReplyInput(button) {
      // ·∫®n t·∫•t c·∫£ c√°c textarea tr·∫£ l·ªùi ƒëang hi·ªÉn th·ªã tr∆∞·ªõc ƒë√≥
      document.querySelectorAll('.comment-textarea').forEach(textarea => {
          textarea.classList.remove('show');
      });

      // T√¨m ph·∫ßn t·ª≠ cha g·∫ßn nh·∫•t l√† comment-item ho·∫∑c reply-item
      const commentContainer = button.closest('.comment-item, .reply-item');

      // T√¨m div v·ªõi contenteditable="true" trong container ƒë√≥
      const replyForm = commentContainer.querySelector('.comment-textarea');

      if (replyForm) {
          const contenteditableDiv = replyForm.querySelector('[contenteditable="true"]'); // L·∫•y div contenteditable
          const fullName = button.getAttribute('data-fullName'); // L·∫•y t√™n ng∆∞·ªùi d√πng ƒë∆∞·ª£c mention
          const mentionSpan = replyForm.querySelector('.reply-mention'); // L·∫•y span ch·ª©a mention

          replyForm.classList.add('show'); // Hi·ªÉn th·ªã form tr·∫£ l·ªùi
          mentionSpan.innerText = `@${fullName} `; // ƒê·∫∑t n·ªôi dung mention

          // Th√™m kho·∫£ng tr·∫Øng v√†o n·ªôi dung div
          contenteditableDiv.innerHTML = mentionSpan.outerHTML + '&nbsp;';

          // T·∫°o m·ªôt range ƒë·ªÉ con tr·ªè n·∫±m sau n·ªôi dung ƒë√£ nh·∫≠p
          const range = document.createRange();
          const selection = window.getSelection();

          // Di chuy·ªÉn con tr·ªè ƒë·∫øn cu·ªëi n·ªôi dung ƒë√£ nh·∫≠p
          range.selectNodeContents(contenteditableDiv);
          range.collapse(false);

          selection.removeAllRanges();
          selection.addRange(range);

          contenteditableDiv.focus(); // T·∫≠p trung v√†o div contenteditable

          // L·∫•y gi√° tr·ªã id c·ªßa ng∆∞·ªùi b√¨nh lu·∫≠n g√°n v√†o form ·∫©n 
          const replyToUserId = button.getAttribute('data-id'); 
          const replyToUserIdInput = document.createElement('input'); 
          replyToUserIdInput.type = 'hidden'; 
          replyToUserIdInput.name = 'replyToUserId'; 
          replyToUserIdInput.value = replyToUserId; 
          replyForm.appendChild(replyToUserIdInput); 
      }
  }

  // H√†m ƒë·ªÉ ·∫©n input tr·∫£ l·ªùi
  function hideReplyInput(button) {
      // T√¨m form cha ch·ª©a n√∫t h·ªßy
      const form = button.closest('form');
      if (form) {
          form.classList.remove('show'); // ·∫®n form tr·∫£ l·ªùi
      }
  }

  // G·∫Øn s·ª± ki·ªán click cho overlay ƒë·ªÉ ƒë√≥ng sidebar
  document.querySelector('.overlay').addEventListener('click', () => toggleComments(true));

  // Ki·ªÉm tra URL ƒë·ªÉ x√°c ƒë·ªãnh xem c√≥ c·∫ßn m·ªü sidebar b√¨nh lu·∫≠n kh√¥ng
  const urlParams = new URLSearchParams(window.location.search);
  const showComments = urlParams.get('showComments');

  if (showComments === 'true') {
      toggleComments(); // M·ªü sidebar
  }

  // X√≥a tham s·ªë showComments kh·ªèi URL
  const url = new URL(window.location);
  url.searchParams.delete('showComments');
  window.history.replaceState({}, document.title, url.toString());

  // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t gi√° tr·ªã c·ªßa input ·∫©n
  function updateHiddenInput(editableDiv) {
      // T√¨m input ·∫©n trong form li·ªÅn k·ªÅ
      const hiddenInput = editableDiv.nextElementSibling;
      if (hiddenInput && hiddenInput.type === "hidden") {
          let content = editableDiv.innerHTML; // L·∫•y n·ªôi dung t·ª´ div contenteditable
          const mentionSpan = editableDiv.querySelector('.reply-mention'); // L·∫•y span mention

          if (mentionSpan) {
              content = content.replace(mentionSpan.outerHTML, ''); // Lo·∫°i b·ªè mention span
          }

          // Thay th·∫ø c√°c k√Ω t·ª± HTML kh√¥ng c·∫ßn thi·∫øt
          content = content.replace(/&nbsp;/g, ' ').replace(/<br>/g, '\n').replace(/<div>|<\/div>/g, '\n');
          hiddenInput.value = content.trim(); // C·∫≠p nh·∫≠t gi√° tr·ªã input ·∫©n
      }
  }
</script>

